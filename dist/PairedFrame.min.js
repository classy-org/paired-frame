var PairedFrame=function(){"use strict";function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(){function k(e){var t=this,n=e.autoNavigate,i=void 0!==n&&n,o=e.autoResize,a=void 0!==o&&o,r=e.debug,s=void 0!==r&&r,u=e.resizeElement,l=void 0===u?null:u,c=e.sendHeight,h=void 0!==c&&c,d=e.sendHistory,g=void 0!==d&&d,f=e.targetOrigin,v=void 0===f?null:f,y=e.targetWindow,m=void 0===y?null:y,p=e.translatePath,b=void 0===p?null:p;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,k),!v||!m)throw new Error("Failed to instantiate PairedFrame: config must include a targetOrigin and targetWindow.");if(a&&!l)throw new Error("Failed to instantiate PairedFrame: config must include a resizeElement when autoResize is true.");this.config=Object.freeze({autoNavigate:i,autoResize:a,debug:s,resizeElement:l,sendHeight:h,sendHistory:g,targetOrigin:v,targetWindow:m,translatePath:b}),this.registry={},this.callbacks=new WeakMap,this.dialogs={},this.hasPendingHeightUpdate=!1,this.localPath=null,this.localHeight=0,this.remotePath=null,this.remoteHeight=0,this.uniqueId=0,addEventListener("message",function(e){return t.receive(e)}),this.onReady(function(){t.once("hello",t.init),t.send("hello")})}var e,t,n;return e=k,(t=[{key:"listeners",value:function(e){var t=this;return(this.registry[e]||[]).map(function(e){return t.callbacks.get(e)})}},{key:"listenerCount",value:function(e){return(this.registry[e]||[]).length}},{key:"eventNames",value:function(){return Object.keys(this.registry)}},{key:"on",value:function(e,t){var n=this.registry[e]||[];return n.push(t),this.registry[e]=n,this.callbacks.set(t,t),this}},{key:"once",value:function(o,a){var r=this,e=function e(){r.off(o,e);for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];a.call.apply(a,[r].concat(n))};return this.callbacks.set(e,a),this.on(o,e)}},{key:"off",value:function(e,t){if(!this.registry[e])return this;var n=this.registry[e].findIndex(function(e){return e===t});return-1===n||this.registry[e].splice(n,1),this}},{key:"emit",value:function(e,t){var n=this,i=this.listenerCount(e);return(this.registry[e]||[]).forEach(function(e){return e.call(n,t)}),Boolean(i)}},{key:"send",value:function(e,t){var n=this.config,i=n.targetOrigin;return n.targetWindow.postMessage({name:e,data:t},i),this.debug("postmessage_sent",e,t),!0}},{key:"receive",value:function(e){var t=e.data,n=e.origin,i=e.source,o=this.config,a=o.targetOrigin,r=o.targetWindow;if(n===a&&i===r&&"object"===l(t)&&t.name){var s=t.name,u=t.data;return this.debug("postmessage_received",s,u),this.emit(s,u)}}},{key:"dialog",value:function(e){var t=this,n="".concat(location.hostname,":").concat(++this.uniqueId);return this.send("dialog-opened",{id:n,config:e}),new Promise(function(e){return t.dialogs[n]=e})}},{key:"onDialog",value:function(i){var o=this;this.on("dialog-opened",function(e){var t=e.id,n=e.config;Promise.resolve(i(n)).then(function(e){return o.send("dialog-closed",{id:t,result:e})})})}},{key:"resolveDialogs",value:function(){var i=this;this.on("dialog-closed",function(e){var t=e.id,n=e.result;i.dialogs[t](n),delete i.dialogs[t]})}},{key:"heartbeat",value:function(){var e=this;setInterval(function(){return e.send("heartbeat")},1e3);var t=function(){e.emit("connection-lost"),e.once("heartbeat",function(){return e.emit("connection-restored")})};this.on("heartbeat",function(){clearTimeout(e.panicId),e.panicId=setTimeout(t,2e3)})}},{key:"sendHeight",value:function(){var n=this;!function e(){var t=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);t!==n.localHeight&&(n.localHeight=t,n.send("resize",{height:t})),requestAnimationFrame(e)}()}},{key:"autoResize",value:function(){var n=this;this.on("resize",function(e){var t=e.height;n.remoteHeight=t}),function e(){n.localHeight!==n.remoteHeight&&(n.config.resizeElement.style.height="".concat(n.remoteHeight,"px"),n.localHeight=n.remoteHeight),requestAnimationFrame(e)}()}},{key:"sendHistory",value:function(){var n=this;!function e(){var t=location.pathname;t!==n.localPath&&(n.localPath=t,n.send("navigate",{path:t})),requestAnimationFrame(e)}()}},{key:"autoNavigate",value:function(){var o=this,a=this.config.translatePath;this.on("navigate",function(e){var t=e.path;o.remotePath=t;var n,i=a?a(t):t;i&&i!==location.pathname&&(history.replaceState(null,"",i),"function"==typeof Event?n=new Event("popstate"):(n=document.createEvent("Event")).initEvent("popstate",!0,!0),n.state=null,dispatchEvent(n))})}},{key:"onReady",value:function(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}},{key:"debug",value:function(e,t,n){this.config.debug&&console.debug(JSON.stringify({"[host]":location.hostname,"[action]":e,name:t,data:n},null,2))}},{key:"init",value:function(){this.send("hello"),this.emit("ready"),this.heartbeat(),this.resolveDialogs(),this.config.sendHeight&&this.sendHeight(),this.config.sendHistory&&this.sendHistory(),this.config.autoResize&&this.autoResize(),this.config.autoNavigate&&this.autoNavigate()}}])&&i(e.prototype,t),n&&i(e,n),k}()}();
