var PairedFrame=function(){"use strict";function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(){function P(e){var t=this,i=e.autoNavigate,n=void 0!==i&&i,o=e.autoResize,a=void 0!==o&&o,r=e.debug,s=void 0!==r&&r,u=e.providePath,l=void 0===u?null:u,c=e.resizeElement,h=void 0===c?null:c,d=e.sendHeight,g=void 0!==d&&d,v=e.sendHistory,f=void 0!==v&&v,y=e.targetOrigin,m=void 0===y?null:y,p=e.targetWindow,b=void 0===p?null:p,k=e.translatePath,H=void 0===k?null:k;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,P),!m||!b)throw new Error("Failed to instantiate PairedFrame: config must include a targetOrigin and targetWindow.");if(a&&!h)throw new Error("Failed to instantiate PairedFrame: config must include a resizeElement when autoResize is true.");this.config=Object.freeze({autoNavigate:n,autoResize:a,debug:s,providePath:l,resizeElement:h,sendHeight:g,sendHistory:f,targetOrigin:m,targetWindow:b,translatePath:H}),this.registry={},this.callbacks=new WeakMap,this.dialogs={},this.hasPendingHeightUpdate=!1,this.localPath=null,this.localHeight=0,this.remotePath=null,this.remoteHeight=0,this.uniqueId=0,this.boundReceiver=this.receive.bind(this),addEventListener("message",this.boundReceiver),this.onReady(function(){t.once("hello",t.init),t.send("hello")})}var e,t,i;return e=P,(t=[{key:"listeners",value:function(e){var t=this;return(this.registry[e]||[]).map(function(e){return t.callbacks.get(e)})}},{key:"listenerCount",value:function(e){return(this.registry[e]||[]).length}},{key:"eventNames",value:function(){return Object.keys(this.registry)}},{key:"on",value:function(e,t){var i=this.registry[e]||[];return i.push(t),this.registry[e]=i,this.callbacks.set(t,t),this}},{key:"once",value:function(o,a){var r=this,e=function e(){r.off(o,e);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];a.call.apply(a,[r].concat(i))};return this.callbacks.set(e,a),this.on(o,e)}},{key:"off",value:function(e,t){if(!this.registry[e])return this;var i=this.registry[e].findIndex(function(e){return e===t});return-1===i||this.registry[e].splice(i,1),this}},{key:"emit",value:function(e,t){var i=this,n=this.listenerCount(e);return(this.registry[e]||[]).forEach(function(e){return e.call(i,t)}),Boolean(n)}},{key:"send",value:function(e,t){var i=this.config,n=i.targetOrigin;return i.targetWindow.postMessage({name:e,data:t},n),this.debug("postmessage_sent",e,t),!0}},{key:"receive",value:function(e){var t=e.data,i=e.origin,n=e.source,o=this.config,a=o.targetOrigin,r=o.targetWindow;if(i===a&&n===r&&"object"===l(t)&&t.name){var s=t.name,u=t.data;return this.debug("postmessage_received",s,u),this.emit(s,u)}}},{key:"dialog",value:function(e){var t=this,i="".concat(location.hostname,":").concat(++this.uniqueId);return this.send("dialog-opened",{id:i,config:e}),new Promise(function(e){return t.dialogs[i]=e})}},{key:"onDialog",value:function(n){var o=this;this.on("dialog-opened",function(e){var t=e.id,i=e.config;Promise.resolve(n(i)).then(function(e){return o.send("dialog-closed",{id:t,result:e})})})}},{key:"resolveDialogs",value:function(){var n=this;this.on("dialog-closed",function(e){var t=e.id,i=e.result;n.dialogs[t](i),delete n.dialogs[t]})}},{key:"heartbeat",value:function(){var e=this;setInterval(function(){return e.send("heartbeat")},1e3);var t=function(){e.emit("connection-lost"),e.once("heartbeat",function(){return e.emit("connection-restored")})};this.on("heartbeat",function(){clearTimeout(e.panicId),e.panicId=setTimeout(t,2e3)})}},{key:"sendHeight",value:function(){var i=this;!function e(){var t=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);t!==i.localHeight&&(i.localHeight=t,i.send("resize",{height:t})),requestAnimationFrame(e)}()}},{key:"autoResize",value:function(){var i=this;this.on("resize",function(e){var t=e.height;i.remoteHeight=t}),function e(){i.localHeight!==i.remoteHeight&&(i.config.resizeElement.style.height="".concat(i.remoteHeight,"px"),i.localHeight=i.remoteHeight),requestAnimationFrame(e)}()}},{key:"sendHistory",value:function(){var n=this,o=this.config.providePath;!function e(){var t=location.pathname;if(t!==n.localPath){var i=o?o(t):null;n.localPath=t,n.send("navigate",{path:t,requestedPath:i})}requestAnimationFrame(e)}()}},{key:"autoNavigate",value:function(){var a=this,r=this.config.translatePath;this.on("navigate",function(e){var t=e.path,i=e.requestedPath;a.remotePath=t;var n,o=r?r(t,i):t;o&&o!==location.pathname&&(history.replaceState(null,"",o),"function"==typeof Event?n=new Event("popstate"):(n=document.createEvent("Event")).initEvent("popstate",!0,!0),n.state=null,dispatchEvent(n))})}},{key:"onReady",value:function(e){var t=this.config,n=t.targetOrigin,o=t.targetWindow,i=new Promise(function(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}),a=new Promise(function(t){if(n===origin)t();else var i=setInterval(function(){try{o.origin!==origin&&(t(),clearInterval(i))}catch(e){t(),clearInterval(i)}},100)});Promise.all([i,a]).then(e)}},{key:"debug",value:function(e,t,i){this.config.debug&&console.debug(JSON.stringify({"[host]":location.hostname,"[action]":e,name:t,data:i},null,2))}},{key:"destroy",value:function(){removeEventListener("message",this.boundReceiver)}},{key:"init",value:function(){this.send("hello"),this.emit("ready"),this.heartbeat(),this.resolveDialogs(),this.config.sendHeight&&this.sendHeight(),this.config.sendHistory&&this.sendHistory(),this.config.autoResize&&this.autoResize(),this.config.autoNavigate&&this.autoNavigate()}}])&&n(e.prototype,t),i&&n(e,i),P}()}();
