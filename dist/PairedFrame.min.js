var PairedFrame=function(){"use strict";return function(){function t(t){var e=t.autoNavigate,i=void 0!==e&&e,n=t.autoResize,o=void 0!==n&&n,r=t.providePath,a=void 0===r?null:r,s=t.resizeElement,h=void 0===s?null:s,d=t.sendHeight,u=void 0!==d&&d,c=t.sendHistory,g=void 0!==c&&c,l=t.targetOrigin,f=t.targetWindow,p=t.translatePath,m=void 0===p?null:p,v=this;if(!l||!f)throw new Error("Failed to instantiate PairedFrame: config must include a targetOrigin and targetWindow.");if(o&&!h)throw new Error("Failed to instantiate PairedFrame: config must include a resizeElement when autoResize is true.");this.config=Object.freeze({autoNavigate:i,autoResize:o,providePath:a,resizeElement:h,sendHeight:u,sendHistory:g,targetOrigin:l,targetWindow:f,translatePath:m}),this.destroyed=!1,this.registry={},this.callbacks=new WeakMap,this.dialogs={},this.hasPendingHeightUpdate=!1,this.localPath=null,this.localHeight=0,this.remotePath=null,this.remoteHeight=0,this.uniqueId=0,this.boundMessageHandler=this.handleMessages.bind(this),this.on("load",function(){window.addEventListener("message",v.boundMessageHandler),v.on("ping",function(){return v.init()}),v.on("pong",function(){return v.init()}),v.on("ping",function(){return v.send("pong")}),v.send("ping")}),this.awaitLoad()}return t.prototype.listeners=function(t){var e=this;return(this.registry[t]||[]).map(function(t){return e.callbacks.get(t)})},t.prototype.listenerCount=function(t){return(this.registry[t]||[]).length},t.prototype.eventNames=function(){return Object.keys(this.registry)},t.prototype.on=function(t,e){var i=this.registry[t]||[];return i.push(e),this.registry[t]=i,this.callbacks.set(e,e),this},t.prototype.once=function(e,i){var n=this,o=function(t){n.off(e,o),i.call(n,t)};return this.callbacks.set(o,i),this.on(e,o)},t.prototype.off=function(t,e){if(!this.registry[t])return this;var i=this.registry[t].findIndex(function(t){return t===e});return-1===i||this.registry[t].splice(i,1),this},t.prototype.emit=function(t,e){var i=this;if(this.destroyed)return!1;var n=(this.registry[t]||[]).slice();return n.forEach(function(t){return setTimeout(t.bind(i,e))}),"*"!==t&&this.emit("*",{name:t,data:e}),Boolean(n.length)},t.prototype.send=function(t,e){if(this.destroyed)return!1;var i=this.config,n=i.targetOrigin,o={name:t,data:e};return i.targetWindow.postMessage(o,n),this.emit("postmessage-sent",{message:o,origin:n}),!0},t.prototype.dialog=function(t){var e=this,i=window.location.hostname+":"+ ++this.uniqueId;return this.emit("dialog-opened",{id:i,config:t}),this.send("dialog-opened",{id:i,config:t}),new Promise(function(t){return e.dialogs[i]=t})},t.prototype.onDialog=function(n){var o=this;return this.on("dialog-opened",function(t){var e=t.id,i=t.config;Promise.resolve(n(i)).then(function(t){o.emit("dialog-closed",{id:e,result:t}),o.send("dialog-closed",{id:e,result:t})})}),this},t.prototype.destroy=function(){return window.removeEventListener("message",this.boundMessageHandler),this.emit("destroy"),this.destroyed=!0},t.prototype.awaitLoad=function(){var t=this,e=this.config,n=e.targetOrigin,o=e.targetWindow,i=new Promise(function(t){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}),r=new Promise(function(e){if(n===origin)e();else var i=setInterval(function(){try{o.origin!==origin&&(e(),clearInterval(i))}catch(t){e(),clearInterval(i)}},100)});Promise.all([i,r]).then(function(){t.emit("load")})},t.prototype.handleMessages=function(t){var e=t.data,i=t.origin,n=t.source,o=this.config,r=o.targetOrigin,a=o.targetWindow;if(i===r&&n===a&&"object"==typeof e&&e.name){this.emit("postmessage-received",{message:e,origin:i});var s=e.name,h=e.data;this.emit(s,h)}},t.prototype.heartbeat=function(){var t=this;setInterval(function(){return t.send("heartbeat")},250);var e=function(){t.emit("connection-lost"),t.once("heartbeat",function(){return t.emit("connection-restored")})};this.on("heartbeat",function(){clearTimeout(t.pulseId),t.pulseId=window.setTimeout(e,500)})},t.prototype.handleDialogs=function(){var n=this;this.on("dialog-closed",function(t){var e=t.id,i=t.result;e&&"function"==typeof n.dialogs[e]&&(n.dialogs[e](i),delete n.dialogs[e])})},t.prototype.sendHeight=function(){var e=this,i=function(){var t=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);t!==e.localHeight&&(e.localHeight=t,e.send("resize",{height:t})),requestAnimationFrame(i)};i()},t.prototype.autoResize=function(){var i=this,e=function(){if(i.config.resizeElement&&i.localHeight!==i.remoteHeight){var t=i.localHeight;i.config.resizeElement.style.height=i.remoteHeight+"px",i.localHeight=i.remoteHeight,i.emit("height-updated",{remoteHeight:i.remoteHeight,previousHeight:t,currentHeight:i.localHeight})}requestAnimationFrame(e)};this.on("resize",function(t){var e=t.height;i.remoteHeight=e}),e()},t.prototype.sendHistory=function(){var o=this,r=this.config.providePath,a=function(){var t=window.location,e=t.hash,i=""+t.pathname+t.search+e;if(i!==o.localPath){var n=r?r(i):null;o.localPath=i,o.send("navigate",{path:i,requestedPath:n})}requestAnimationFrame(a)};a()},t.prototype.autoNavigate=function(){var h=this,d=this.config.translatePath;this.on("navigate",function(t){var e=t.path,i=t.requestedPath;h.remotePath=e;var n,o=window.location,r=o.hash,a=""+o.pathname+o.search+r,s=d?d(e,i):e;s&&s!==a&&(history.replaceState(null,"",s),"function"==typeof Event?n=new Event("popstate"):(n=document.createEvent("Event")).initEvent("popstate",!0,!0),n.state=null,dispatchEvent(n),h.emit("path-updated",{remotePath:e,requestedPath:i,previousPath:a,currentPath:s}))})},t.prototype.init=function(){this.off("ping",this.init),this.off("pong",this.init),this.heartbeat(),this.handleDialogs(),this.config.sendHeight&&this.sendHeight(),this.config.sendHistory&&this.sendHistory(),this.config.autoResize&&this.autoResize(),this.config.autoNavigate&&this.autoNavigate(),this.emit("ready")},t}()}();
