var PairedFrame=function(){"use strict";return function(){function t(t){var e=t.autoNavigate,i=void 0!==e&&e,n=t.autoResize,o=void 0!==n&&n,r=t.debug,a=void 0!==r&&r,s=t.providePath,h=void 0===s?null:s,c=t.resizeElement,u=void 0===c?null:c,l=t.sendHeight,d=void 0!==l&&l,g=t.sendHistory,f=void 0!==g&&g,v=t.targetOrigin,p=t.targetWindow,m=t.translatePath,y=void 0===m?null:m,b=this;if(!v||!p)throw new Error("Failed to instantiate PairedFrame: config must include a targetOrigin and targetWindow.");if(o&&!u)throw new Error("Failed to instantiate PairedFrame: config must include a resizeElement when autoResize is true.");this.config=Object.freeze({autoNavigate:i,autoResize:o,debug:a,providePath:h,resizeElement:u,sendHeight:d,sendHistory:f,targetOrigin:v,targetWindow:p,translatePath:y}),this.registry={},this.callbacks=new WeakMap,this.dialogs={},this.hasPendingHeightUpdate=!1,this.localPath=null,this.localHeight=0,this.remotePath=null,this.remoteHeight=0,this.uniqueId=0,this.boundReceiver=this.receive.bind(this),addEventListener("message",this.boundReceiver),this.onReady(function(){b.once("hello",b.init),b.send("hello")})}return t.prototype.listeners=function(t){var e=this;return(this.registry[t]||[]).map(function(t){return e.callbacks.get(t)})},t.prototype.listenerCount=function(t){return(this.registry[t]||[]).length},t.prototype.eventNames=function(){return Object.keys(this.registry)},t.prototype.on=function(t,e){var i=this.registry[t]||[];return i.push(e),this.registry[t]=i,this.callbacks.set(e,e),this},t.prototype.once=function(e,i){var n=this,o=function(t){n.off(e,o),i.call(n,t)};return this.callbacks.set(o,i),this.on(e,o)},t.prototype.off=function(t,e){if(!this.registry[t])return this;var i=this.registry[t].findIndex(function(t){return t===e});return-1===i||this.registry[t].splice(i,1),this},t.prototype.emit=function(t,e){var i=this,n=this.listenerCount(t);return(this.registry[t]||[]).forEach(function(t){return t.call(i,e)}),Boolean(n)},t.prototype.send=function(t,e){var i=this.config,n=i.targetOrigin;return i.targetWindow.postMessage({name:t,data:e},n),this.debug("postmessage_sent",t,e),!0},t.prototype.receive=function(t){var e=t.data,i=t.origin,n=t.source,o=this.config,r=o.targetOrigin,a=o.targetWindow;if(i===r&&n===a&&"object"==typeof e&&e.name){var s=e.name,h=e.data;return this.debug("postmessage_received",s,h),this.emit(s,h)}},t.prototype.dialog=function(t){var e=this,i=location.hostname+":"+ ++this.uniqueId;return this.send("dialog-opened",{id:i,config:t}),new Promise(function(t){return e.dialogs[i]=t})},t.prototype.onDialog=function(n){var o=this;this.on("dialog-opened",function(t){var e=t.id,i=t.config;Promise.resolve(n(i)).then(function(t){return o.send("dialog-closed",{id:e,result:t})})})},t.prototype.resolveDialogs=function(){var n=this;this.on("dialog-closed",function(t){var e=t.id,i=t.result;n.dialogs[e](i),delete n.dialogs[e]})},t.prototype.heartbeat=function(){var t=this;setInterval(function(){return t.send("heartbeat")},1e3);var e=function(){t.emit("connection-lost"),t.once("heartbeat",function(){return t.emit("connection-restored")})};this.on("heartbeat",function(){clearTimeout(t.pulseId),t.pulseId=window.setTimeout(e,2e3)})},t.prototype.sendHeight=function(){var e=this,i=function(){var t=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);t!==e.localHeight&&(e.localHeight=t,e.send("resize",{height:t})),requestAnimationFrame(i)};i()},t.prototype.autoResize=function(){var i=this,t=function(){i.config.resizeElement&&i.localHeight!==i.remoteHeight&&(i.config.resizeElement.style.height=i.remoteHeight+"px",i.localHeight=i.remoteHeight),requestAnimationFrame(t)};this.on("resize",function(t){var e=t.height;i.remoteHeight=e}),t()},t.prototype.sendHistory=function(){var i=this,n=this.config.providePath,o=function(){var t=location.pathname;if(t!==i.localPath){var e=n?n(t):null;i.localPath=t,i.send("navigate",{path:t,requestedPath:e})}requestAnimationFrame(o)};o()},t.prototype.autoNavigate=function(){var r=this,a=this.config.translatePath;this.on("navigate",function(t){var e=t.path,i=t.requestedPath;r.remotePath=e;var n,o=a?a(e,i):e;o&&o!==location.pathname&&(history.replaceState(null,"",o),"function"==typeof Event?n=new Event("popstate"):(n=document.createEvent("Event")).initEvent("popstate",!0,!0),n.state=null,dispatchEvent(n))})},t.prototype.onReady=function(t){var e=this.config,n=e.targetOrigin,o=e.targetWindow,i=new Promise(function(t){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}),r=new Promise(function(e){if(n===origin)e();else var i=setInterval(function(){try{o.origin!==origin&&(e(),clearInterval(i))}catch(t){e(),clearInterval(i)}},100)});Promise.all([i,r]).then(t)},t.prototype.debug=function(t,e,i){this.config.debug&&console.debug(JSON.stringify({"[host]":location.hostname,"[action]":t,name:e,data:i},null,2))},t.prototype.destroy=function(){removeEventListener("message",this.boundReceiver)},t.prototype.init=function(){this.send("hello"),this.emit("ready"),this.heartbeat(),this.resolveDialogs(),this.config.sendHeight&&this.sendHeight(),this.config.sendHistory&&this.sendHistory(),this.config.autoResize&&this.autoResize(),this.config.autoNavigate&&this.autoNavigate()},t}()}();
