var PairedFrame=function(){"use strict";function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(){function b(e){var t=this,i=e.autoNavigate,n=void 0!==i&&i,a=e.autoResize,o=void 0!==a&&a,r=e.debug,s=void 0!==r&&r,u=e.mapPath,c=void 0===u?null:u,l=e.resizeElement,h=void 0===l?null:l,g=e.sendHeight,d=void 0!==g&&g,v=e.sendHistory,f=void 0!==v&&v,m=e.targetOrigin,y=void 0===m?null:m,p=e.targetWindow,k=void 0===p?null:p;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,b),!y||!k)throw new Error("Failed to instantiate PairedFrame: config must include a targetOrigin and targetWindow.");if(o&&!h)throw new Error("Failed to instantiate PairedFrame: config must include a resizeElement when autoResize is true.");this.config=Object.freeze({autoNavigate:n,autoResize:o,debug:s,mapPath:c,resizeElement:h,sendHeight:d,sendHistory:f,targetOrigin:y,targetWindow:k}),this.registry={},this.callbacks=new WeakMap,this.dialogs={},this.hasPendingHeightUpdate=!1,this.localPath=null,this.localHeight=0,this.remotePath=null,this.remoteHeight=0,this.uniqueId=0,addEventListener("message",function(e){return t.receive(e)}),this.onReady(function(){t.once("ping",t.init),t.send("ping")})}var e,t,i;return e=b,(t=[{key:"listeners",value:function(e){var t=this;return(this.registry[e]||[]).map(function(e){return t.callbacks.get(e)})}},{key:"listenerCount",value:function(e){return(this.registry[e]||[]).length}},{key:"eventNames",value:function(){return Object.keys(this.registry)}},{key:"on",value:function(e,t){var i=this.registry[e]||[];return i.push(t),this.registry[e]=i,this.callbacks.set(t,t),this}},{key:"once",value:function(a,o){var r=this,e=function e(){r.off(a,e);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];o.call.apply(o,[r].concat(i))};return this.callbacks.set(e,o),this.on(a,e)}},{key:"off",value:function(e,t){if(!this.registry[e])return this;var i=this.registry[e].findIndex(function(e){return e===t});return-1===i||this.registry[e].splice(i,1),this}},{key:"emit",value:function(e,t){var i=this,n=this.listenerCount(e);return(this.registry[e]||[]).forEach(function(e){return e.call(i,t)}),Boolean(n)}},{key:"send",value:function(e,t){var i=this.config,n=(i.debug,i.targetOrigin);return i.targetWindow.postMessage({name:e,data:t},n),this.debug("postmessage_sent",e,t),!0}},{key:"receive",value:function(e){var t=e.data,i=t.name,n=t.data,a=e.origin,o=(e.source,this.config),r=(o.debug,o.targetOrigin);o.targetWindow;if(a===r)return this.debug("postmessage_received",i,n),this.emit(i,n)}},{key:"dialog",value:function(e){var t=this,i="".concat(location.hostname,":").concat(++this.uniqueId);return this.send("dialog-opened",{id:i,config:e}),new Promise(function(e){return t.dialogs[i]=e})}},{key:"onDialog",value:function(n){var a=this;this.on("dialog-opened",function(e){var t=e.id,i=e.config;Promise.resolve(n(i)).then(function(e){return a.send("dialog-closed",{id:t,result:e})})})}},{key:"resolveDialogs",value:function(){var n=this;this.on("dialog-closed",function(e){var t=e.id,i=e.result;n.dialogs[t](i),delete n.dialogs[t]})}},{key:"heartbeat",value:function(){var e=this;setInterval(function(){return e.send("heartbeat")},1e3);var t=function(){e.emit("connection-lost"),e.once("heartbeat",function(){return e.emit("connection-restored")})};this.on("heartbeat",function(){clearTimeout(e.panicId),e.panicId=setTimeout(t,2e3)})}},{key:"sendHeight",value:function(){var i=this;!function e(){var t=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);t!==i.localHeight&&(i.localHeight=t,i.send("resize",{height:t})),requestAnimationFrame(e)}()}},{key:"autoResize",value:function(){var i=this;this.on("resize",function(e){var t=e.height;i.remoteHeight=t}),function e(){i.localHeight!==i.remoteHeight&&(i.config.resizeElement.style.height="".concat(i.remoteHeight,"px"),i.localHeight=i.remoteHeight),requestAnimationFrame(e)}()}},{key:"sendHistory",value:function(){var i=this;!function e(){var t=document.location.pathname;t!==i.localPath&&(i.localPath=t,i.send("navigate",{path:t})),requestAnimationFrame(e)}()}},{key:"autoNavigate",value:function(){var a=this,o=this.config.mapPath;this.on("navigate",function(e){var t=e.path;a.remotePath=t;var i,n=o?o(t):t;n?n!==document.location.pathname&&(history.replaceState(null,"",n),"function"==typeof Event?i=new Event("popstate"):(i=document.createEvent("Event")).initEvent("popstate",!0,!0),i.state=null,dispatchEvent(i)):a.warn("Failed to map remote path to local; aborting navigation.")})}},{key:"onReady",value:function(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}},{key:"debug",value:function(e,t,i){this.config.debug&&console.debug(JSON.stringify({"[host]":location.hostname,"[action]":e,name:t,data:i},null,2))}},{key:"warn",value:function(e){console.warn("[PairedFrame] ".concat(e))}},{key:"init",value:function(){this.send("ping"),this.emit("ready"),this.heartbeat(),this.resolveDialogs(),this.config.sendHeight&&this.sendHeight(),this.config.sendHistory&&this.sendHistory(),this.config.autoResize&&this.autoResize(),this.config.autoNavigate&&this.autoNavigate()}}])&&n(e.prototype,t),i&&n(e,i),b}()}();
