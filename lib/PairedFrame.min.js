"use strict";function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){if(t)_defineProperties(e.prototype,t);if(i)_defineProperties(e,i);return e}var PairedFrame=function(){function e(t,i){var n=this;var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};_classCallCheck(this,e);var r=a.applyHeight,o=r===void 0?false:r,s=a.applyHistory,l=s===void 0?false:s,u=a.debug,h=u===void 0?false:u,c=a.iframeElement,f=c===void 0?null:c,g=a.mapPath,v=g===void 0?null:g,d=a.resizeElement,y=d===void 0?null:d,m=a.watchHeight,p=m===void 0?false:m,H=a.watchHistory,w=H===void 0?false:H;this.config=Object.freeze({applyHeight:o,applyHistory:l,debug:h,iframeElement:f,mapPath:v,targetOrigin:i,targetWindow:t,watchHeight:p,watchHistory:w,resizeElement:y});this.registry={};this.rawListeners=new WeakMap;this.localPath=null;this.localHeight=0;this.remoteHeight=0;this.pendingHeightUpdate=false;this.inDialog=false;window.addEventListener("message",function(e){return n.receive(e)});this.onReady(function(){n.once("ping",n.init);n.send("ping")})}_createClass(e,[{key:"listeners",value:function e(t){var i=this;return(this.registry[t]||[]).map(function(e){return i.rawListeners.get(e)})}},{key:"listenerCount",value:function e(t){return(this.registry[t]||[]).length}},{key:"eventNames",value:function e(){return Object.keys(this.registry)}},{key:"on",value:function e(t,i){var n=this.registry[t]||[];n.push(i);this.registry[t]=n;this.rawListeners.set(i,i);return this}},{key:"once",value:function e(t,i){var n=this;var a=function e(){n.off(t,e);for(var a=arguments.length,r=new Array(a),o=0;o<a;o++){r[o]=arguments[o]}i.call.apply(i,[n].concat(r))};this.rawListeners.set(a,i);return this.on(t,a)}},{key:"off",value:function e(t,i){if(!this.registry[t])return this;var n=this.registry[t].findIndex(function(e){return e===i});if(n===-1)return this;this.registry[t].splice(n,1);return this}},{key:"emit",value:function e(t,i){var n=this;var a=this.listenerCount(t);(this.registry[t]||[]).forEach(function(e){return e.call(n,i)});return Boolean(a)}},{key:"send",value:function e(t,i){var n=this.config,a=n.debug,r=n.targetOrigin,o=n.targetWindow;o.postMessage({name:t,data:i},r);if(a){console.log(JSON.stringify({"[host]":location.hostname,"[action]":"SENT",name:t,data:i},null,2))}return true}},{key:"receive",value:function e(t){var i=t.data,n=i.name,a=i.data,r=t.origin,o=t.source;var s=this.config,l=s.debug,u=s.targetOrigin,h=s.targetWindow;if(o!==h)return;if(r!==u)return;if(l){console.log(JSON.stringify({"[host]":location.hostname,"[action]":"RECEIVED",name:n,data:a},null,2))}return this.emit(n,a)}},{key:"notify",value:function e(t,i){return this.send(t,i)}},{key:"dialog",value:function e(t){var i=this;if(this.inDialog)return;this.inDialog=true;return new Promise(function(e){i.once("dialog-closed",function(t){var n=t.result;i.inDialog=false;e(n)});i.send("dialog-opened",t)})}},{key:"heartbeat",value:function e(){var t=this;setInterval(function(){return t.send("heartbeat")},1e3)}},{key:"watchHeight",value:function e(){var t=this;var i=function e(){var i=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);if(i!==t.localHeight){t.localHeight=i;t.send("resize",{height:i})}requestAnimationFrame(e)};i()}},{key:"applyHeight",value:function e(){var t=this;var i=this.config.resizeElement;if(!i)return;var n=function e(){if(t.localHeight!==t.remoteHeight){i.style.height="".concat(t.remoteHeight,"px");t.localHeight=t.remoteHeight}requestAnimationFrame(e)};this.on("resize",function(e){var i=e.height;t.remoteHeight=i});n()}},{key:"watchHistory",value:function e(){var t=this;var i=function e(){var i=document.location.pathname;if(i!==t.localPath){t.localPath=i;t.send("navigate",{path:i})}requestAnimationFrame(e)};i()}},{key:"applyHistory",value:function e(){var t=this.config.mapPath;this.on("navigate",function(e){var i=e.path;var n=t?t(i):i;if(!n)return;if(n===document.location.pathname)return;history.replaceState(null,"",n);var a;if(typeof Event==="function"){a=new Event("popstate")}else{a=document.createEvent("Event");a.initEvent("popstate",true,true)}a.state=null;window.dispatchEvent(a)})}},{key:"onReady",value:function e(t){var i=this.config.iframeElement;setTimeout(function(){var e=new Promise(function(e){if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",e)}else{e()}});var n=new Promise(function(e){if(i){i.addEventListener("load",e)}else{e()}});Promise.all([e,n]).then(function(){t()})})}},{key:"init",value:function e(){this.send("ping");this.emit("ready");this.heartbeat();if(this.config.watchHeight)this.watchHeight();if(this.config.watchHistory)this.watchHistory();if(this.config.applyHeight)this.applyHeight();if(this.config.applyHistory)this.applyHistory()}}]);return e}();