"use strict";function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){if(t)_defineProperties(e.prototype,t);if(i)_defineProperties(e,i);return e}var PairedFrame=function(){function e(t){var i=this;var n=t.autoNavigate,a=n===void 0?false:n,r=t.autoResize,o=r===void 0?false:r,s=t.debug,u=s===void 0?false:s,l=t.mapPath,c=l===void 0?null:l,h=t.resizeElement,f=h===void 0?null:h,g=t.sendHeight,d=g===void 0?false:g,v=t.sendHistory,m=v===void 0?false:v,y=t.targetIframe,p=y===void 0?null:y,k=t.targetOrigin,b=k===void 0?null:k,H=t.targetWindow,w=H===void 0?null:H;_classCallCheck(this,e);if(!b||!w){throw new Error("Failed to instantiate PairedFrame: config must include a "+"targetOrigin and targetWindow.")}if(o&&!f){throw new Error("Failed to instantiate PairedFrame: config must include a "+"resizeElement when autoResize is true.")}this.config=Object.freeze({autoNavigate:a,autoResize:o,debug:u,mapPath:c,resizeElement:f,sendHeight:d,sendHistory:m,targetIframe:p,targetOrigin:b,targetWindow:w});this.registry={};this.callbacks=new WeakMap;this.hasPendingHeightUpdate=false;this.localPath=null;this.localHeight=0;this.remotePath=null;this.remoteHeight=0;addEventListener("message",function(e){return i.receive(e)});this.onReady(function(){i.once("ping",i.init);i.send("ping")})}_createClass(e,[{key:"listeners",value:function e(t){var i=this;return(this.registry[t]||[]).map(function(e){return i.callbacks.get(e)})}},{key:"listenerCount",value:function e(t){return(this.registry[t]||[]).length}},{key:"eventNames",value:function e(){return Object.keys(this.registry)}},{key:"on",value:function e(t,i){var n=this.registry[t]||[];n.push(i);this.registry[t]=n;this.callbacks.set(i,i);return this}},{key:"once",value:function e(t,i){var n=this;var a=function e(){n.off(t,e);for(var a=arguments.length,r=new Array(a),o=0;o<a;o++){r[o]=arguments[o]}i.call.apply(i,[n].concat(r))};this.callbacks.set(a,i);return this.on(t,a)}},{key:"off",value:function e(t,i){if(!this.registry[t])return this;var n=this.registry[t].findIndex(function(e){return e===i});if(n===-1)return this;this.registry[t].splice(n,1);return this}},{key:"emit",value:function e(t,i){var n=this;var a=this.listenerCount(t);(this.registry[t]||[]).forEach(function(e){return e.call(n,i)});return Boolean(a)}},{key:"send",value:function e(t,i){var n=this.config,a=n.debug,r=n.targetOrigin,o=n.targetWindow;o.postMessage({name:t,data:i},r);this.debug("postmessage_sent",t,i);return true}},{key:"receive",value:function e(t){var i=t.data,n=i.name,a=i.data,r=t.origin,o=t.source;var s=this.config,u=s.debug,l=s.targetOrigin,c=s.targetWindow;if(r!==l)return;this.debug("postmessage_received",n,a);return this.emit(n,a)}},{key:"notify",value:function e(t,i){return this.send(t,i)}},{key:"dialog",value:function e(t){var i=this;if(this.inDialog)return;this.inDialog=true;return new Promise(function(e){i.once("dialog-closed",function(t){var n=t.result;i.inDialog=false;e(n)});i.send("dialog-opened",t)})}},{key:"onDialog",value:function e(t){var i=this;this.on("dialog-opened",function(e){Promise.resolve(t(e)).then(function(){i.send("dialog-closed",{result:result})})})}},{key:"heartbeat",value:function e(){var t=this;setInterval(function(){return t.send("heartbeat")},1e3);var i=function e(){t.emit("connection-lost");t.once("heartbeat",function(){return t.emit("connection-restored")})};var n=function e(){clearTimeout(t.panicId);t.panicId=setTimeout(i,2e3)};this.on("heartbeat",n)}},{key:"sendHeight",value:function e(){var t=this;var i=function e(){var i=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);if(i!==t.localHeight){t.localHeight=i;t.send("resize",{height:i})}requestAnimationFrame(e)};i()}},{key:"autoResize",value:function e(){var t=this;var i=function e(){if(t.localHeight!==t.remoteHeight){t.config.resizeElement.style.height="".concat(t.remoteHeight,"px");t.localHeight=t.remoteHeight}requestAnimationFrame(e)};this.on("resize",function(e){var i=e.height;t.remoteHeight=i});i()}},{key:"sendHistory",value:function e(){var t=this;var i=function e(){var i=document.location.pathname;if(i!==t.localPath){t.localPath=i;t.send("navigate",{path:i})}requestAnimationFrame(e)};i()}},{key:"autoNavigate",value:function e(){var t=this;var i=this.config.mapPath;this.on("navigate",function(e){var n=e.path;t.remotePath=n;var a=i?i(n):n;if(!a){t.warn("Failed to map remote path to local; aborting navigation.");return}if(a===document.location.pathname)return;history.replaceState(null,"",a);var r;if(typeof Event==="function"){r=new Event("popstate")}else{r=document.createEvent("Event");r.initEvent("popstate",true,true)}r.state=null;dispatchEvent(r)})}},{key:"onReady",value:function e(t){var i=this;var n=new Promise(function(e){if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",e)}else{e()}});var a=new Promise(function(e){if(i.config.targetIframe){i.config.targetIframe.addEventListener("load",e)}else{e()}});Promise.all([n,a]).then(function(){t()})}},{key:"debug",value:function e(t,i,n){if(!this.config.debug)return;console.debug(JSON.stringify({"[host]":location.hostname,"[action]":t,name:i,data:n},null,2))}},{key:"warn",value:function e(t){console.warn("[PairedFrame] ".concat(t))}},{key:"init",value:function e(){this.send("ping");this.emit("ready");this.heartbeat();if(this.config.sendHeight)this.sendHeight();if(this.config.sendHistory)this.sendHistory();if(this.config.autoResize)this.autoResize();if(this.config.autoNavigate)this.autoNavigate()}}]);return e}();