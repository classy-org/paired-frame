"use strict";class PairedFrame{constructor({autoNavigate:t=false,autoResize:e=false,debug:i=false,mapPath:s=null,resizeElement:n=null,sendHeight:a=false,sendHistory:o=false,targetIframe:r=null,targetOrigin:h=null,targetWindow:l=null}){if(!h||!l){throw new Error("PairedFrame config must include a targetOrigin and targetWindow.")}this.config=Object.freeze({autoNavigate:t,autoResize:e,debug:i,mapPath:s,resizeElement:n,sendHeight:a,sendHistory:o,targetIframe:r,targetOrigin:h,targetWindow:l});this.registry={};this.callbacks=new WeakMap;this.hasPendingHeightUpdate=false;this.localPath=null;this.localHeight=0;this.remotePath=null;this.remoteHeight=0;addEventListener("message",t=>this.receive(t));this.onReady(()=>{this.once("ping",this.init);this.send("ping")})}listeners(t){return(this.registry[t]||[]).map(t=>this.callbacks.get(t))}listenerCount(t){return(this.registry[t]||[]).length}eventNames(){return Object.keys(this.registry)}on(t,e){const i=this.registry[t]||[];i.push(e);this.registry[t]=i;this.callbacks.set(e,e);return this}once(t,e){const i=(...s)=>{this.off(t,i);e.call(this,...s)};this.callbacks.set(i,e);return this.on(t,i)}off(t,e){if(!this.registry[t])return this;const i=this.registry[t].findIndex(t=>t===e);if(i===-1)return this;this.registry[t].splice(i,1);return this}emit(t,e){const i=this.listenerCount(t);(this.registry[t]||[]).forEach(t=>t.call(this,e));return Boolean(i)}send(t,e){const{debug:i,targetOrigin:s,targetWindow:n}=this.config;n.postMessage({name:t,data:e},s);this.log("postmessage_sent",t,e);return true}receive({data:{name:t,data:e},origin:i,source:s}){const{debug:n,targetOrigin:a,targetWindow:o}=this.config;if(i!==a)return;this.log("postmessage_received",t,e);return this.emit(t,e)}notify(t,e){return this.send(t,e)}dialog(t){if(this.inDialog)return;this.inDialog=true;return new Promise(e=>{this.once("dialog-closed",({result:t})=>{this.inDialog=false;e(t)});this.send("dialog-opened",t)})}onDialog(t){this.on("dialog-opened",e=>{Promise.resolve(t(e)).then(()=>{this.send("dialog-closed",{result:result})})})}heartbeat(){setInterval(()=>this.send("heartbeat"),1e3);const t=()=>{this.emit("connection-lost");this.once("heartbeat",()=>this.emit("connection-restored"))};const e=()=>{clearTimeout(this.panicId);this.panicId=setTimeout(t,2e3)};this.on("heartbeat",e)}sendHeight(){const t=()=>{const e=Math.min(document.body.scrollHeight,document.documentElement.scrollHeight);if(e!==this.localHeight){this.localHeight=e;this.send("resize",{height:e})}requestAnimationFrame(t)};t()}autoResize(){const t=this.config.resizeElement;if(!t)return;const e=()=>{if(this.localHeight!==this.remoteHeight){t.style.height=`${this.remoteHeight}px`;this.localHeight=this.remoteHeight}requestAnimationFrame(e)};this.on("resize",({height:t})=>{this.remoteHeight=t});e()}sendHistory(){const t=()=>{const e=document.location.pathname;if(e!==this.localPath){this.localPath=e;this.send("navigate",{path:e})}requestAnimationFrame(t)};t()}autoNavigate(){const{mapPath:t}=this.config;this.on("navigate",({path:e})=>{this.remotePath=e;const i=t?t(e):e;if(!i)return;if(i===document.location.pathname)return;history.replaceState(null,"",i);let s;if(typeof Event==="function"){s=new Event("popstate")}else{s=document.createEvent("Event");s.initEvent("popstate",true,true)}s.state=null;dispatchEvent(s)})}onReady(t){const{targetIframe:e}=this.config;setTimeout(()=>{const i=new Promise(t=>{if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",t)}else{t()}});const s=new Promise(t=>{if(e){e.addEventListener("load",t)}else{t()}});Promise.all([i,s]).then(()=>{t()})})}log(t,e,i){if(!this.debug)return;console.log(JSON.stringify({"[host]":location.hostname,"[action]":t,name:e,data:i},null,2))}init(){this.send("ping");this.emit("ready");this.heartbeat();if(this.config.sendHeight)this.sendHeight();if(this.config.sendHistory)this.sendHistory();if(this.config.autoResize)this.autoResize();if(this.config.autoNavigate)this.autoNavigate()}}